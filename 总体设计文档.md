# Bookstore总体设计文档

## 项目信息
- 项目名称: 书店管理系统
- 文档作者: 陈墨涵

## 程序功能概述
书店管理系统是一个基于命令行的图书管理应用，支持账户管理、图书信息管理、交易处理和日志记录功能。
系统采用文件存储方式，不将数据存储于内存，实时读写文件数据。

## 主体逻辑说明
系统采用命令行交互方式，通过解析输入指令执行相应操作。
程序启动时自动初始化root账户，读取指令直到EOF或退出命令。

## 代码文件结构 & 类、结构体设计 & 功能设计
### 账户系统模块 (AccountSystem)
```
struct Account {
    char userID[31];
    char password[31];
    char username[31];
    int privilege;
};
class AccountSystem {
private:
    BlockLinkedList<30, Account>* accountStorage; // userID -> 账户信息
    std::vector<Account> loginStack; // 记录都有哪些用户登录
    std::map<string, string> selectedBooks; // userID -> ISBN
public:
    AccountSystem(); // 申请空间
    ~AccountSystem(); // 释放空间

    // 登录：若成功则修改登录栈
    // {0}
    void su(const string& userID, const string& password = "");

    // 登出登录栈中最后一个账户
    // 若无已登录帐户则操作失败
    // {1}
    void logout();

    // 注册权限等级为 {1} 的新账户
    // 若userID与已注册用户重复则失败
    // {0}
    void registerAccount(const string& userID, const string& password, const string& username);

    // 修改密码，权限为{7}账户可以不输入旧密码
    // 若userID不存在则失败，若旧密码不正确则不存在
    // {1}
    void passwd(const string& userID, const string& newPassword, const string& currentPassword = "");

    // 创建账户
    // 若userID与已注册账户重复则失败，若待创建帐户的权限等级 >= 当前帐户权限等级则失败
    // {3}
    void useradd(const string& userID, const string& password, int privilege, const string& username);

    // 删除账户
    // 若该账户不存在或已登录则失败
    // {7}
    void deleteAccount(const string& userID);
};

```

### 图书管理模块 (BookSystem)
```
struct Book {
    char ISBN[21];
    char name[61];
    char author[61];
    char keyword[61];
    int quantity;
    double price;
};

class BookSystem {
private:
    BlockLinkedList<20, Book>* bookStorage; // ISBN -> 整体图书信息

    // 为了方便后面将ISBN与图书各类信息（name等）封装成块状链表，定义一个结构体
    struct ISBNValue {
        char isbn[21];
        ISBNValue() {
            for (int i = 0; i < 21; ++i) isbn[i] = 0;
        }
        bool operator<(const ISBNValue& other) const {
            return (strcmp(isbn, other.isbn) < 0);
        }
        bool operator==(const ISBNValue& other) const {
            return (strcmp(isbn, other.isbn) == 0);
        }
        bool operator>(const ISBNValue& other) const {
            return (strcmp(isbn, other.isbn) > 0);
        }
    };

    BlockLinkedList<60, ISBNValue>* nameISBN; // name -> ISBN
    BlockLinkedList<60, ISBNValue>* authorISBN; // author -> ISBN
    BlockLinkedList<60, ISBNValue>* keywordISBN; // keyword -> ISBN

    AccountSystem* accountSystem;
    FinanceSystem* financeSystem;


public:
    BookSystem(AccountSystem* as, FinanceSystem* fs); // s申请空间并初始化
    ~BookSystem(); // 释放空间

    // 无附加参数时，输出所有图书
    // {1} （所有show都是）
    void show();

    // 按ISBN查询
    // 输出：图书信息或空行（未找到时）; "Invalid"（ISBN为空时）
    void show(const string& ISBN);

    // field表示属于哪个板块（如name）
    // 输出：图书信息或空行（未找到时）; "Invalid"（附加参数内容为空时，[Keyword] 中出现多个关键词时）
    void show(const string& field, const string& value);

    // 输出: 总价（成功）; "Invalid"（失败：权限不足/图书不存在/库存不足/quantity<=0）
    // {1}
    void buy(const string& ISBN, int quantity);

    // 查找图书，如果不存在则创建空白图书
    // 输出: 无输出（成功）; "Invalid"（权限不足）
    // {3}
    void select(const string& ISBN);

    // {3}
    void modify(const string& line);

    // 失败：未选择书 / 购入数量 <= 0 / 总额 <= 0
    // {3}
    void import(int quantity, double totalCost);
};
```

### 日志系统 (FinanceSystem)
```
struct Transaction {
    double amount;      // 正数为收入，负数为支出
    long long index;    // 交易序号（第几笔交易）
};

struct OperationLog {
    char userID[31];
    char operation[150];
    long long index;    // 操作序号（第几次操作）
};

class FinanceSystem {
private:
    vector<Transaction> transaction;
    vector<OperationLog> operation;
    long long transactionCounter;
    long long operationCounter;
    fstream financeFile;
    fstream logFile;

public:
    // 打开文件
    FinanceSystem();

    // 保存、关闭文件
    ~FinanceSystem();

    // 记录交易，分配序号（++transactionCounter）
    void recordTransaction(double amount);

    // 记录用户操作日志，分配序号（++operationCounter）
    void recordOperation(const string& userID, const string& operation);

    // count = -1 输出全部 / count = 0 输出空行
    // {7}
    void showFinance(int count = -1);

    // {7}
    void printFinanceReport();
    void printEmployeeReport();
    void printLog();

};
```

### 主程序 (main.cpp)
只需初始化并且解析单行命令


## 数据库设计
### 存储数据
用户信息、图书信息、操作记录、财务信息
### 存储方式
用户和图书信息用块状链表，操作记录和财务信息用数组（只需在末尾添加，并且只用按顺序查找）